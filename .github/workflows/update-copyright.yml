name: Update Copyright Year

on:
  schedule:
    # Run on January 1st at 00:00 UTC every year
    - cron: '0 0 1 1 *'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-copyright:
    runs-on: ubuntu-24.04-16cores-public

    steps:
    - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
      id: app-token
      with:
        app-id: ${{ vars.GH_APP_ID }}
        private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        token: ${{ steps.app-token.outputs.token }}
        persist-credentials: false

    - name: Set current year
      id: date
      run: echo "year=$(date +'%Y')" >> $GITHUB_OUTPUT

    - name: Run copyright update script
      env:
        YEAR: ${{ steps.date.outputs.year }}
      run: |
        ./scripts/update-copyright-year.sh
        
    - name: Check for changes
      id: changes
      run: |
        if [[ $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Files have been updated"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes needed"
        fi
        
    - name: Create Pull Request
      if: steps.changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
      with:
        token: ${{ steps.app-token.outputs.token }}
        commit-message: "chore: update copyright year to ${{ steps.date.outputs.year }}"
        title: "chore: update copyright year to ${{ steps.date.outputs.year }}"
        body: |
          This PR updates the copyright year in all source files from 2018 to ${{ steps.date.outputs.year }}.

          Changes:
          - Updated copyright headers in all .kt, .java, and .sh files
          - Updated copyright template file

          This is an automated update triggered by the scheduled workflow.
        branch: copyright-year-update-${{ steps.date.outputs.year }}
        labels: skip-changelog
        delete-branch: true
        
    - name: Output result
      run: |
        if [[ "${STEPS_CHANGES_OUTPUTS_CHANGES}" == "true" ]]; then
          echo "Copyright year has been updated and a PR has been created"
        else
          echo "Copyright year is already current, no action needed"
        fi
      env:
        STEPS_CHANGES_OUTPUTS_CHANGES: ${{ steps.changes.outputs.changes }}
